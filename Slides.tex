% This presentation is based on a Beamer theme from Seth Brown, distributed
% under the following license:
%
% ----------------------------------------------------------------------------
% This program can be redistributed and/or modified under the terms
% of the GNU Public License, version 3.
%
% Seth Brown, Ph.D.
% sethbrown@drbunsen.org

\documentclass[t,aspectratio=169]{beamer}

\usepackage{graphicx} % graphics
\usepackage{fancyvrb}
\usepackage{tcolorbox}
\usepackage{animate}

\usefonttheme{professionalfonts}
\usepackage{unicode-math}
\setmathfont{Cambria Math}
\setmathfont[range={\mathit}]{Cambria Math}
\setmathfont[range={\mathup}]{Cambria Math}

% suppress navigation bar
\beamertemplatenavigationsymbolsempty

\mode<presentation>
{
  \usetheme{codeplay}
  \setbeamercovered{transparent}
  %\setbeamertemplate{itemize item}[circle]
  \setbeamertemplate{itemize item}{\small\raise0.8pt\hbox{$\bullet$}}
  %\setbeamertemplate{itemize subitem}{\tiny\raise1.5pt\hbox{\donotcoloroutermaths$\blacktriangleright$}}
  \setbeamertemplate{itemize subitem}{\tiny\raise1.5pt\hbox{$\blacktriangleright$}}
  \setbeamertemplate{section in toc shaded}[default][100]
  \setbeamertemplate{subsection in toc shaded}[default][100]

\setbeamertemplate{subsection in toc}{%
\leavevmode\leftskip=4.00ex%
  \llap{\raisebox{0.15ex}{\textcolor{structure}{\small$\bullet$}}\kern1ex}%
  \inserttocsubsection\par%
}
}

% set fonts
\usepackage{fontspec}
\setsansfont{Calibri}
\setmonofont{Consolas}
\setbeamerfont{frametitle}{size=\LARGE,series=\bfseries}

% color definitions
\usepackage{color}
\definecolor{uiwhite}{RGB}{255, 255, 255}
\definecolor{uidarkgray}{RGB}{24,24,25}
\definecolor{uigray}{RGB}{51,51,51}
\definecolor{uilightgray}{RGB}{123,123,123}
\definecolor{uicyan}{RGB}{0,255,255}
\definecolor{uipink}{RGB}{255,153,255}
\definecolor{uipalegreen}{RGB}{153,255,153}
\definecolor{uiorange}{RGB}{237,175,28}
\hypersetup{colorlinks,urlcolor=uicyan,linkcolor=uiwhite}

% title slide definition
\title{Creating an SPMD Vectorizer for OpenCL with LLVM}
\subtitle{LLVM 2015 Tutorial}
\author{Pierre-Andr√© Saulais}
\institute{Codeplay Software \\ @codeplaysoft}

\date{\today}

% Code box formatting
\fvset{fontsize=\scriptsize,tabsize=4}
\tcbset{colback=uigray,colframe=uilightgray,colupper=uiwhite,
        left=1pt,right=1pt,top=1pt,bottom=1pt,arc=0pt,
        toprule=1pt,bottomrule=1pt,leftrule=1pt,rightrule=1pt}

\newenvironment{codebox}
 {\VerbatimEnvironment
  \begin{tcolorbox}%
  \begin{Verbatim}}
 {\end{Verbatim}\end{tcolorbox}}

% Code caption that comes after the code box.
\newcommand{\codecaption}[2][-4.4ex]{%
  \vspace{#1}
  \hfill\mbox{\footnotesize{\textcolor{uicyan}{#2}}\hspace{0.5em}}
  \vspace*{2ex}}

\newcommand{\sourcebox}[3][firstline=1]{%
  \begin{tcolorbox}\VerbatimInput[#1]{#2}\end{tcolorbox}
  \codecaption{#3}}

\newcommand{\examplebox}[2][firstline=1]{\sourcebox[#1]{examples/#2}{#2}}

\newcommand{\codeempha}[1]{\textcolor{uipink}{#1}}
\newcommand{\codeemphb}[1]{\textcolor{uicyan}{#1}}
\newcommand{\codeemphc}[1]{\textcolor{uipalegreen}{#1}}
\newcommand{\codeemphd}[1]{\textcolor{uiorange}{#1}}

\newcommand{\varying}[1]{\codeempha{#1}}
\newcommand{\uniform}[1]{\codeemphb{#1}}
\newcommand{\idx}[1]{[#1]}

\newcommand{\pointfor}[1]{\textbf{\codeemphb{+}}\hspace{0.5em}#1}
\newcommand{\pointunkn}[1]{\textbf{?}\hspace{0.5em}#1}
\newcommand{\pointagainst}[1]{\textbf{\codeempha{-}}\hspace{0.5em}#1}

%\newcommand{\penguin}[0]{\includegraphics[width = 1em]{images/penguin.png}}

\newcommand{\penguin}[0]{\animategraphics[loop,autoplay, width = 1.5em]{12}{images/penguins/penguin-}{0}{19}\hspace{0.1em}}
\newcommand{\penguins}[0]{<\hspace{0.15em}\penguin, \penguin, \penguin, \penguin, \penguin, \penguin, \penguin, \penguin\hspace{0.1em}>}

% Create a slide for a part.
\newcommand{\talkpart}[2]{%
\section{Part #1: #2}

\begin{frame}[c]{Part #1}

\vspace{1cm}
\centerline{\LARGE{#2}}

\end{frame}}

% Create a slide for a part section.
\newcommand{\talksection}[1]{%
\subsection{#1}
\begin{frame}{\insertsectionhead}
\vspace{2ex}
\begin{NoHyper}
\tableofcontents[sectionstyle=hide,subsectionstyle=show/shaded/hide]
\end{NoHyper}
\end{frame}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

%\setbeamertemplate{background}
%{\includegraphics[width=\paperwidth,height=\paperheight]{dark_background_title.png}}
\setbeamertemplate{footline}[default]

\begin{frame}
  \vspace{4ex}
  \titlepage
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Set the background for the rest of the slides.
%\setbeamertemplate{background}
% {\includegraphics[width=\paperwidth,height=\paperheight]{dark_background.png}}
\setbeamertemplate{background}{}
\setbeamertemplate{footline}[codeplaytheme]

\section*{Introduction}

\begin{frame}{What this tutorial is about}

%% TODO: Logos of OpenCL, CUDA, LLVM?

\begin{itemize}
    \item Introduction to
    \begin{itemize}
        \item Create a basic vectorizer
    \end{itemize}  
    \item Vectorizing
    \begin{itemize}
        \item Transform whole functions using LLVM
        \item "Horizontal" vectorization
    \end{itemize}  
    \item SPMD (Single Program, Multiple Data) Kernels
    \begin{itemize}
        \item Data-parallel execution model
        \item Used with compute frameworks like OpenCL and CUDA
    \end{itemize}
    \item for CPU-like processors, i.e. each core has
    \begin{itemize}
        \item A program counter
        \item Vector SIMD unit(s)
    \end{itemize}
\end{itemize}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Overview}
\tableofcontents
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\talkpart{1}{Background}
\include{Slides-part1}

\talkpart{2}{Implementing a SPMD Vectorizer}
\include{Slides-part2_overview}
\include{Slides-part2_packetization}
\include{Slides-part2_scalarization}
%\include{Slides-part2_control_flow}

%\talkpart{3}{Going further}
%\include{Slides-part3}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Conclusion}

\begin{frame}{References}

\begin{itemize}
    \item Automatic Packetization [Ralf Karrenberg, Saarland University '09]
    \item Intel(R) OpenCL Implicit Vectorization Module [Nadav Rotem, LLVM '11]
    \item Improving Performance of OpenCL on CPUs [Ralf Karrenberg et al., EuroLLVM '12]
    \item Branching in Data-Parallel Languages using Prediction with LLVM [Marcello Maggioni, EuroLLVM '14]
    \item Exploring the Design Space of SPMD Divergence Management on Data-Parallel Architectures [Yunsup Lee et al., MICRO '14]
\end{itemize}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Summary}

\begin{itemize}
    \item Should be enough to get started and create a functional vectorizer
    \item Many things were not covered in this talk:
    \begin{itemize}
        \item ...
    \end{itemize}
    \item Introduced resources to go further
\end{itemize}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Thank you!}

\begin{itemize}
    \item Q\&A
    \item ...
    \item Happy vectorizing!
    \begin{itemize}
        \item \penguins
    \end{itemize}
\end{itemize}

\vspace{5em}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}
