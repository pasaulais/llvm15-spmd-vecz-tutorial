\talksection{Control Flow Conversion Stage}

\begin{frame}{Control Flow Conversion Overview}

\begin{itemize}
    \item Linearizes functions that have \varying{divergent} control flow
    \begin{itemize}
        \item All basic blocks are executed
        \item Program semantics are preserved using predication (masking)
    \end{itemize}
    \item Why is it needed?
    \begin{itemize}
        \item SIMD unit does not support 'vector' (\varying{divergent}) branches
        \item Single program counter per SIMD group
    \end{itemize}
    \item Requires some passes to be run in the 'Prepare' stage
    \begin{itemize}
        \item Functions should have a single return block
        \item Loops should be in 'simple form'
    \end{itemize}
\end{itemize}

\vfill
\hspace{1em}\includegraphics[scale=0.55]{images/stages-control-flow.pdf}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile]{Control Flow Conversion: if}

\begin{minipage}[t]{0.45\linewidth}

\begin{itemize}
    \item Divergent branch condition: \varying{cond}
    \item Instruction with side-effects: \texttt{load}
\end{itemize}

\begin{codebox}[commandchars=\\\[\]]
kernel void copy_if_even(global int \uniform[*src],
                         global int \uniform[*dst]) {
  int \varying[tid] = \varying[get_global_id(0)];
  int \varying[cond] = (\varying[tid] & \uniform[1]) == \uniform[0];
  int result;
  if (\varying[cond]) {
    \varying[result] = \uniform[src]\idx[\varying[tid]];
  } else {
    \uniform[result] = \uniform[-1];
  }
  \uniform[dst]\idx[\varying[tid]] = \varying[result];
}
\end{codebox}

\end{minipage}
\hspace{1em}
\begin{minipage}[t]{0.48\linewidth}

\vspace{0.1ex}
\center{[CFG of the example]}

\end{minipage}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Basic Divergence Analysis}

\begin{minipage}[t]{0.45\linewidth}

\begin{itemize}
    \item Determines which basic blocks need predication (i.e. it is \varying{divergent})
    \item BB is \varying{divergent} if:
    \begin{itemize}
        \item Any predecessor has a branch with \varying{varying} condition
        \item Any predecessor is \varying{divergent} (naive)
    \end{itemize}
    \item Process:
    \begin{itemize}
        \item Start with the entry BB
        \item Mark successors \varying{divergent} or not
        \item Visit all successors recursively
        \item Visit each BB only once (cycles)
    \end{itemize}
\end{itemize}

\end{minipage}
\hspace{1em}
\begin{minipage}[t]{0.48\linewidth}

\vspace{0.1ex}
\center{[CFG of the example]}

\end{minipage}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Mask Generation}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Applying Masks}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Masked Memory Operations}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Phi Conversion}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{CFG Linearization}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Control Flow Conversion: loops}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Finding Loop Live Variables}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Merging Loop Live Variables}

\end{frame}
